### 一、先明确：Java 线程池（核心）核心参数（以`ThreadPoolExecutor`为例）

首先要理清线程池的核心参数，后续配置都是围绕这些参数展开，其中最关键的是**核心线程数、最大线程数**，也是你关注的`20`大概率对应的参数：

1. **核心线程数（corePoolSize）**：线程池长期保留的存活线程数，即使处于空闲状态也不会被回收（除非设置了`allowCoreThreadTimeOut=true`）。
2. **最大线程数（maximumPoolSize）**：线程池能容纳的最大线程数，当任务队列满了之后，会创建新线程直到达到该数值。
3. **任务队列（workQueue）**：用于缓存等待执行任务的阻塞队列（如`ArrayBlockingQueue`、`LinkedBlockingQueue`）。
4. **空闲线程存活时间（keepAliveTime）**：超出核心线程数的空闲线程，存活的最大时间，超时后会被回收。
5. **拒绝策略（handler）**：当线程数达到最大线程数、任务队列也满了时，对新任务的处理策略（如丢弃、抛异常、调用者自行执行）。

你关注的`20`，大概率是`corePoolSize`（核心线程数）或`maximumPoolSize`（最大线程数）的配置值。

### 二、线程池参数：经验值配置（快速落地，无需压测的场景）

经验值配置是基于**任务类型（CPU 密集型 / IO 密集型）\**和\**服务器硬件配置**总结的快速配置方案，适合联调、测试环境，或对性能要求不极致的生产场景，`20`这类数值也多来自经验值的延伸。

#### 1.  先区分任务类型（核心前提）

线程池的任务主要分为两类，两者的配置逻辑差异极大，这是经验值的核心依据：

- **CPU 密集型任务**：任务执行过程中，主要消耗 CPU 资源（无大量 IO 等待，如数据计算、排序、加密解密等）。

  核心特点：线程执行任务时，CPU 利用率接近 100%，线程过多会导致 CPU 上下文切换频繁，反而降低整体性能。

  经验值配置公式：

  `核心线程数 ≈ CPU核心数 + 1`（或 `CPU核心数 * 2`，适用于部分多核场景，预留少量线程应对突发）

  示例：8 核 CPU 的服务器，CPU 密集型任务的核心线程数配置为`8-16`之间，很少会配置到`20`（除非是 32 核以上服务器）。

  

- **IO 密集型任务**：任务执行过程中，大量时间消耗在 IO 等待上（如数据库查询、Redis 操作、网络请求、文件读写等），CPU 利用率较低。

  核心特点：线程大部分时间处于空闲等待状态，适当增加线程数，可以提高 CPU 利用率，提升任务处理吞吐量。

  经验值配置公式（两种常用）：

  公式 1：`核心线程数 ≈ CPU核心数 * 2`

  公式 2（更精准）：`核心线程数 ≈ CPU核心数 / (1 - 阻塞系数)`（阻塞系数通常为 0.8~0.9，即线程 80%-90% 的时间在 IO 等待）

  示例：8 核 CPU 的服务器，按公式 2 计算：`8 / (1 - 0.9) = 80`，实际生产中常配置为`20-100`之间（根据 IO 阻塞程度调整），这就是你看到的`20`的核心由来 ——**IO 密集型任务下，基于 8 核 / 16 核 CPU 的经验值配置**。

  

#### 2.  其他参数的经验值配套配置

- 任务队列：IO 密集型任务建议使用有界队列（如`ArrayBlockingQueue`），容量配置为`100-1000`（避免无界队列导致内存溢出）；CPU 密集型任务队列容量可稍大（`500-2000`）。
- 存活时间：默认`60s`即可满足大部分场景，无需额外调整（空闲线程超时回收，不浪费资源）。
- 拒绝策略：生产环境优先选择`CallerRunsPolicy`（调用者线程执行任务，避免任务直接丢弃，同时起到限流作用），测试环境可选择`AbortPolicy`（抛异常，快速发现问题）。

### 三、线程池参数：压测调优（生产环境极致性能，确定最终最优值）

经验值只是 “入门配置”，**生产环境的最终参数（包括是否保留`20`），必须通过压测来验证和调整**，这是保证线程池性能最优的核心手段，尤其是高并发、高吞吐量的场景（如游戏服务端、电商支付系统）。

#### 1.  压测的核心目标

验证线程池配置是否满足：**最大吞吐量、最低响应时间、无任务丢失、无内存溢出**，同时找到 “线程数 - 吞吐量 - 响应时间” 的最优平衡点。

#### 2.  压测的关键步骤（围绕线程池参数展开）

1. **准备压测环境**：搭建与生产环境硬件配置（CPU 核心数、内存、磁盘）一致的压测环境，避免硬件差异导致压测结果失真。

2. 确定压测指标

   ：核心关注 4 个指标：

   - 吞吐量（QPS）：单位时间内处理的任务数。
   - 响应时间（RT）：包括平均响应时间、P95、P99（更能反映极端场景）。
   - 线程池利用率：核心线程是否长期处于忙碌状态、是否频繁创建 / 销毁非核心线程（避免频繁上下文切换）。
   - 系统资源利用率：CPU 利用率、内存使用率、磁盘 IO / 网络 IO（避免资源耗尽）。

   

3. 控制变量法调优（核心步骤）

   ：

   - 固定其他参数（任务队列容量、存活时间等），只调整`corePoolSize`（从经验值`20`开始，上下浮动，如 10、15、20、25、30）。
   - 对每个`corePoolSize`值，进行梯度压测（从低并发到高并发，逐步增加请求量）。
   - 记录每个配置下的核心指标，找到 “吞吐量最高、响应时间最低、CPU 利用率在 70%-80%（最佳区间）” 的`corePoolSize`值。
   - 同理，固定`corePoolSize`，调整`maximumPoolSize`和任务队列容量，验证队列满后，最大线程数是否能有效提升吞吐量，且无任务拒绝。

   

4. **验证极限场景**：进行峰值压测（如预期生产并发的 1.5 倍），验证线程池在极限压力下的表现，是否会出现 OOM、任务大量拒绝、响应时间陡增等问题，微调参数优化容错能力。

#### 3.  压测调优的核心判断依据（以`20`为例）

如果经验值配置了`20`，压测后出现以下情况，需要调整：

- 情况 1：吞吐量上不去，CPU 利用率低于 50%，响应时间偏长 → 说明线程数不足（IO 等待过多），可上调至 25、30。
- 情况 2：CPU 利用率达到 90% 以上，响应时间陡增，吞吐量下降 → 说明线程数过多，上下文切换频繁，可下调至 15、10。
- 情况 3：频繁触发拒绝策略，且核心线程、最大线程都处于忙碌状态，队列已满 → 可适当调大最大线程数（如 20→30）或队列容量（需避免 OOM）。

### 四、线程池参数设置的核心原则（总结）

1. **先经验，后压测**：经验值是快速落地的基础（尤其是 IO 密集型任务的`20`左右配置），压测是生产环境最优解的保障，两者缺一不可，不能只依赖经验值，也不能跳过经验值直接盲目压测。
2. **紧扣任务类型**：CPU 密集型少线程，IO 密集型多线程，这是配置的核心前提，`20`这类数值只适用于 IO 密集型任务，不适用于 CPU 密集型任务。
3. **拒绝无界队列**：即使是经验配置，也不要使用`LinkedBlockingQueue`（无界队列），否则任务堆积会导致内存溢出，线上问题难以排查。
4. **动态调整（进阶）**：对于流量波动较大的场景（如电商大促、游戏开服），可基于压测结果实现线程池参数动态调整（如通过配置中心修改`corePoolSize`、`maximumPoolSize`，无需重启服务）。

### 总结

1. `20`这类线程池参数首先来自**IO 密集型任务的经验值**（基于 CPU 核心数和阻塞系数推导），适合快速落地。
2. 生产环境的最终最优参数，必须通过**控制变量法压测**验证，围绕吞吐量、响应时间、系统资源利用率调整。
3. 核心逻辑：先区分任务类型（CPU/IO 密集型），再用经验值打底，最后用压测确定最优值，同时规避无界队列等坑。
